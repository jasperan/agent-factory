# Security Incident Report: Exposed API Keys in Git History

**Date**: 2025-12-27
**Severity**: CRITICAL
**Status**: PARTIALLY RESOLVED

## Summary
Multiple API keys and credentials were accidentally committed to git history across 4 documentation files. While the rivet-bot branch has been cleaned using BFG Repo-Cleaner, secrets remain in other branches due to GitHub's large file size limits preventing full cleanup.

## Exposed Credentials

### Priority 1: Actively Committed (Still Visible in Other Branches)
1. **ENV_FILES_GUIDE.md** (commit 221288d, ~50 branches)
   - Telegram Bot Token: `8264955123:AAHLiOZmJXrO...`
   - Neon Database Password: `npg_N4SDwv1IfmUX@...`
   - Supabase Service Role Key (partial)
   - OpenAI API Key (partial)
   - Anthropic API Key (partial)
   - Render API Key: `rnd_E28gCMELQo0u...`
   - Railway API Token: `2db9f13b-9fe2-...`
   - Admin Chat ID: `8445149012`

2. **DIAGNOSTIC_SESSION_2025-12-23.md** (multiple commits, other branches)
   - Supabase Password: `$!hLQDYB#uW23DJ`

### Priority 2: Deleted but Recoverable from History (Other Branches)
3. **docs/FIXES_APPLIED_2025-12-23.md** (deleted in commit 39e7f59)
   - Groq API Key: `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`
   - Supabase passwords (before/after fix)

4. **langsmith info.txt** (cleaned from rivet-bot ✓)
   - LangSmith API keys: `lsv2_pt_b41d37144a32464d...`
   - **Status**: Removed from rivet-bot branch only

## Response Actions Taken

### Completed
1. ✅ BFG Repo-Cleaner successfully removed ALL 4 files from rivet-bot branch
   - langsmith info.txt (1.1 KB, 57 objects changed)
   - ENV_FILES_GUIDE.md (7.8 KB, 836 objects changed!)
   - DIAGNOSTIC_SESSION_2025-12-23.md (9.6 KB, 98 objects)
   - FIXES_APPLIED_2025-12-23.md (3.7 KB, 96 objects)
   - **Total**: 1,087 object IDs rewritten

2. ✅ rivet-bot branch history cleaned and pushed to GitHub

3. ✅ .gitignore updated with prevention patterns:
   - `ENV_FILES_GUIDE.md`
   - `DIAGNOSTIC_SESSION_*.md`
   - `*FIXES_APPLIED*.md`

4. ✅ Git bundle backup created: `agent-factory-backup-20251227.bundle`

### Blocked
1. ❌ Full repository cleanup (all 50+ branches) blocked by GitHub
   - Error: Large file detected (141MB node_modules file)
   - `products/landing/node_modules/@next/swc-win32-x64-msvc/next-swc.win32-x64-msvc.node`
   - Exceeds GitHub's 100MB file size limit
   - Requires Git LFS or file removal before full push

### Pending (CRITICAL - User Action Required)
1. ⚠️ API Key Rotation - ALL exposed credentials MUST be rotated immediately:
   - [ ] Telegram Bot Token → @BotFather → `/token` → Generate new → Update `.env.vps` → Restart bot
   - [ ] Neon Database Password → https://console.neon.tech → Reset password
   - [ ] Supabase Service Role Key → Supabase dashboard → Reset key
   - [ ] OpenAI API Key → https://platform.openai.com/api-keys → Revoke + Generate new
   - [ ] Anthropic API Key → https://console.anthropic.com/settings/keys → Revoke + Generate new
   - [ ] Groq API Key → https://console.groq.com/keys → Revoke + Generate new
   - [ ] Render API Key → https://dashboard.render.com/account → Regenerate
   - [ ] Railway API Token → https://railway.app/account/tokens → Regenerate
   - [ ] Update ALL `.env*` files with new credentials
   - [ ] Test database connections
   - [ ] Restart bot on VPS

## Impact Assessment

### Rivet-Bot Branch (CLEAN ✅)
- ✅ All secrets removed from git history
- ✅ Safe to deploy from this branch
- ✅ No exposed credentials in commit history

### Other Branches (COMPROMISED ⚠️)
- ❌ ~50 branches still contain secrets in history
- ❌ Secrets remain accessible via `git log --all -p`
- ❌ Cannot push cleaned history due to large file issue

### Public Exposure Risk
- Repository visibility: **Private** (GitHub)
- Exposure window: Dec 14, 2025 (commit 221288d) - Dec 27, 2025 (cleanup)
- ~13 days of potential exposure
- **Mitigation**: Private repo limits exposure to collaborators only

## Root Cause Analysis

### How Did This Happen?
1. **Documentation with real credentials** - `ENV_FILES_GUIDE.md` included actual API keys as examples instead of placeholders
2. **Diagnostic sessions** - Debug files captured live credentials
3. **Fix documentation** - `FIXES_APPLIED_2025-12-23.md` logged actual API keys during troubleshooting
4. **LangSmith setup** - Copy-pasted API keys directly from LangSmith console into txt file

### Contributing Factors
- No pre-commit hook to detect secrets
- No automated secret scanning in CI/CD
- Documentation files not covered by .gitignore patterns initially
- Real credentials used in examples instead of `YOUR_API_KEY_HERE` placeholders

## Lessons Learned

### What Worked
1. ✅ BFG Repo-Cleaner extremely effective (single run, 4 files, 1,087 objects cleaned)
2. ✅ Git bundle backup provided safety net
3. ✅ Branch-level cleanup successful when full cleanup blocked

### What Failed
1. ❌ No pre-commit secret detection
2. ❌ Large binary files blocking full cleanup
3. ❌ Documentation files with real credentials committed without review

## Prevention Measures (Implementation Required)

### 1. Pre-Commit Hook (HIGH PRIORITY)
```bash
# Option 1: gitleaks (fast, zero dependencies)
# Download: https://github.com/gitleaks/gitleaks/releases
# Install to .git/hooks/pre-commit

# Option 2: detect-secrets (Python-based, configurable)
pip install detect-secrets
detect-secrets scan --baseline .secrets.baseline
# Add to .pre-commit-config.yaml
```

### 2. .gitignore Patterns (COMPLETE)
- ✅ Added ENV_FILES_GUIDE.md
- ✅ Added DIAGNOSTIC_SESSION_*.md
- ✅ Added *FIXES_APPLIED*.md
- ✅ Comprehensive wildcard patterns for *info.txt, *credentials*, etc.

### 3. Documentation Standards (NEW POLICY)
- ❌ NEVER use real API keys in documentation
- ✅ ALWAYS use placeholder format: `YOUR_API_KEY_HERE` or `sk-...REDACTED`
- ✅ Mark sensitive sections with `# SECURITY: Replace before committing`
- ✅ Review all docs/* files before commits

### 4. Git LFS for Large Files (TO DO)
- Resolve GitHub push blocking by migrating large binaries to Git LFS
- Enables full repository history cleanup across all branches

## Next Steps

### Immediate (User Action Required)
1. **Rotate ALL API keys** (see Pending section above) - **DO THIS TODAY**
2. Test all services still work with new credentials
3. Document rotated keys in secure password manager

### Short Term (1-2 days)
1. Install pre-commit hook (gitleaks or detect-secrets)
2. Set up Git LFS for large binary files
3. Re-run BFG cleanup on all branches after LFS migration
4. Force push all cleaned branches to GitHub

### Long Term (1-2 weeks)
1. Audit all documentation files for embedded secrets
2. Implement CI/CD secret scanning (GitHub secret scanning already active)
3. Create internal security review checklist for commits
4. Monthly git history audits for exposed credentials

## BFG Repo-Cleaner Evaluation

### Performance
- ✅ **Extremely fast**: Cleaned 752 commits in <1 second
- ✅ **Simple syntax**: `--delete-files "filename"` intuitive
- ✅ **Thorough**: Rewrote 1,087 objects across 4 files in single run
- ✅ **Reliable**: No corruption, clean report output

### Comparison to git filter-branch
- **Speed**: 10-720x faster (BFG cleaned 1,087 objects in 655ms)
- **Ease of use**: One-line command vs complex filter-branch scripts
- **Safety**: Built-in HEAD protection (overridable with --no-blob-protection)

### Recommendation
**ESSENTIAL TOOL** - Keep BFG JAR in project for emergency use.

**When to use:**
- ✅ Accidentally committed API keys/secrets
- ✅ Need to remove multiple files from history quickly
- ✅ Large repos (>100k commits) where filter-branch too slow

**When NOT to use:**
- Large file issues blocking push (need Git LFS first)
- Want to rewrite commit messages (use git filter-branch)
- Need fine-grained control over specific commits

### Storage
- Location: `C:\Users\hharp\Tools\bfg\bfg-1.14.0.jar`
- Size: 13.8 MB
- Version: 1.14.0 (latest stable)

## Timeline

| Time | Event |
|------|-------|
| Dec 14, 2025 | ENV_FILES_GUIDE.md committed with 7 API keys (commit 221288d) |
| Dec 23, 2025 | DIAGNOSTIC_SESSION and FIXES_APPLIED committed with credentials |
| Dec 27, 04:27 | Initial attempt to remove langsmith info.txt (commit 204d239) |
| Dec 27, 04:27 | WS-3 voice integration completed (commit 4618c9f) |
| Dec 27, 04:30 | GitHub push blocked - secret detection triggered |
| Dec 27, 05:00 | BFG Repo-Cleaner implemented |
| Dec 27, 05:05 | All 4 files cleaned from rivet-bot branch |
| Dec 27, 05:06 | Rivet-bot branch pushed to GitHub successfully |
| Dec 27, 05:10 | Other branches still compromised (large file blocks full cleanup) |

## Contacts

**Incident Owner**: Claude Sonnet 4.5 (AI Assistant)
**Repository Owner**: Mike Cranesync (mike@cranesync.com)
**GitHub Repo**: https://github.com/Mikecranesync/Agent-Factory (Private)

## Attachments

- BFG Report: `C:\Users\hharp\OneDrive\Desktop\agent-factory-mirror.git.bfg-report\2025-12-27\`
- Git Backup: `C:\Users\hharp\OneDrive\Desktop\agent-factory-backup-20251227.bundle`
- BFG Playbook: `docs/patterns/GIT_SECRET_REMOVAL.md` (to be created)

---

**Classification**: INTERNAL
**Distribution**: Project Owner Only
**Retention**: 7 years (compliance requirement)
